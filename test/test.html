<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mua BMHD bằng TON</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</head>
<body>
    <h2>Mua BMHD bằng TON</h2>
    <p>1 TON = 1000 BMHD</p>
    <input type="number" id="tonAmount" placeholder="Nhập số TON" min="0.01" step="0.01">
    <button onclick="sendTON()">Mua BMHD</button>
    <p id="status"></p>

    <!-- Thêm phần tử để hiển thị UI kết nối ví TON -->
    <div id="ton-connect"></div> <!-- Nơi hiển thị nút kết nối ví -->

    <script>
        // Khởi tạo TONConnectUI
        const tonConnectUI = new TONConnectUI.TonConnectUI({
            manifestUrl: 'https://bmasshd.click/tonconnect-manifest.json', // URL tệp manifest
            buttonRootId: 'ton-connect' // Đặt nút kết nối ví vào phần tử này
        });

        // Tùy chọn khi kết nối (ví dụ, trả về URL)
        tonConnectUI.uiOptions = {
            twaReturnUrl: 'https://t.me/bmassk3_bot/?startapp=' // Link trả về sau khi kết nối ví
        };

        // Kết nối ví
        async function connectToWallet() {
            try {
                // Kết nối với ví
                const connectedWallet = await tonConnectUI.connectWallet();
                
                if (connectedWallet) {
                    console.log('Đã kết nối với ví:', connectedWallet);
                    document.getElementById('status').innerText = "Ví đã được kết nối thành công!";
                }
            } catch (error) {
                console.error("Lỗi kết nối ví:", error);
                document.getElementById('status').innerText = "Lỗi kết nối ví: " + error.message;
            }
        }

        // Gửi giao dịch TON và nhận BMHD
        async function sendTON() {
            const amountTON = parseFloat(document.getElementById('tonAmount').value);
            if (isNaN(amountTON) || amountTON <= 0) {
                document.getElementById('status').innerText = "Vui lòng nhập số TON hợp lệ.";
                return;
            }

            try {
                // Kiểm tra nếu ví đã kết nối
                if (!tonConnectUI.isConnected()) {
                    document.getElementById('status').innerText = "Vui lòng kết nối ví trước!";
                    return;
                }

                // Địa chỉ nhận TON
                const recipient = "UQDu8vyZSZbAYvRRQ_jW4_0EiBGibAGq72wSZjYWRmNAGhRD"; // Địa chỉ hợp đồng hoặc ví nhận

                // Tạo giao dịch gửi TON
                const transaction = {
                    messages: [
                        {
                            address: recipient,
                            amount: (amountTON * 1e9).toString(), // Chuyển đổi TON sang nanotons (1 TON = 1e9 nanotons)
                        }
                    ]
                };

                // Gửi giao dịch
                const tx = await tonConnectUI.sendTransaction(transaction);
                console.log(tx);

                // Cập nhật trạng thái giao dịch
                document.getElementById('status').innerText = "Giao dịch gửi thành công! Vui lòng chờ nhận BMHD.";
            } catch (error) {
                document.getElementById('status').innerText = "Lỗi giao dịch: " + error.message;
            }
        }

        // Kết nối ví khi trang tải
        connectToWallet();
    </script>
</body>
</html>

