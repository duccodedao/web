<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Thêm thẻ meta này -->
  <title>Mini App + Referral</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
      color: #333;
    }
    .dark-mode {
      background: #222;
      color: white;
    }
    button {
      padding: 10px 20px;
      margin: 5px 0;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <h2>Telegram Mini App</h2>
  <div id="user-info"></div>
  <div id="ref-info"></div>
  <div id="token-info"></div>
  <button onclick="checkIn()">Điểm danh nhận token</button>
  <button onclick="copyReferral()">Copy link giới thiệu</button>

  <script>
    const tg = Telegram.WebApp;
    tg.ready();

    const user = tg.initDataUnsafe.user;
    const ref = tg.initDataUnsafe.start_param || null;

    // Tự động mở rộng giao diện
    tg.expand();

    // Giao diện tối nếu Telegram đặt vậy
    if (tg.colorScheme === 'dark') {
      document.body.classList.add('dark-mode');
    }

    // Hiển thị thông tin người dùng
    document.getElementById('user-info').innerHTML = `
      <b>ID:</b> ${user?.id}<br>
      <b>Tên:</b> ${user?.first_name || ''} ${user?.last_name || ''}<br>
      <b>Username:</b> @${user?.username || 'Không có'}<br><br>
    `;

    // Lưu ref chỉ lần đầu
    if (ref && !localStorage.getItem('ref_used')) {
      localStorage.setItem('ref_used', '1');
      localStorage.setItem('ref_from', ref);
      // Tặng 20 token nếu nhập qua ref
      const current = parseInt(localStorage.getItem('token') || '0');
      localStorage.setItem('token', current + 20);
    }

    // Hiển thị ref đã dùng
    const refFrom = localStorage.getItem('ref_from');
    if (refFrom) {
      document.getElementById('ref-info').innerHTML = `
        <b>Được mời bởi ID:</b> ${refFrom} <br>Nhận thêm 20 token!
      `;
    }

    // Hiển thị số token hiện có
    updateTokenUI();

    function updateTokenUI() {
      const tokens = parseInt(localStorage.getItem('token') || '0');
      document.getElementById('token-info').innerHTML = `<b>Tổng token:</b> ${tokens}`;
    }

    // Điểm danh mỗi ngày
    function checkIn() {
      const today = new Date().toLocaleDateString();
      const last = localStorage.getItem('last_checkin');
      if (today === last) {
        alert("Bạn đã điểm danh hôm nay.");
        return;
      }
      localStorage.setItem('last_checkin', today);
      const current = parseInt(localStorage.getItem('token') || '0');
      localStorage.setItem('token', current + 10);
      alert("Điểm danh thành công! Nhận 10 token.");
      updateTokenUI();
    }

    // Copy link giới thiệu
    function copyReferral() {
      const refLink = `https://t.me/${tg.initDataUnsafe.bot.username}?startapp=${user.id}`;
      
      // Tạo một input tạm thời để copy
      const input = document.createElement('input');
      input.value = refLink;
      document.body.appendChild(input);
      
      // Chọn và sao chép nội dung của input
      input.select();
      document.execCommand('copy');
      
      // Xóa input tạm thời sau khi sao chép
      document.body.removeChild(input);
      
      alert("Đã copy link giới thiệu:\n" + refLink);
    }
  </script>

</body>
</html>
