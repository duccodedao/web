<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>TON</title>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="/css/footer.css">
  <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', 'Roboto', sans-serif;
  background: #1e1e2f;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  color: #f1f1f1;
}

#connect-only {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}

.container {
  display: none;
  background: #2a2a40;
  border-radius: 20px;
  box-shadow:
    inset 2px 2px 5px rgba(0, 0, 0, 0.3),
    inset -2px -2px 5px rgba(255, 255, 255, 0.03),
    0 8px 24px rgba(0, 0, 0, 0.5);
  padding: 30px;
  max-width: 480px;
  width: 100%;
  text-align: center;
  overflow-y: auto;
  max-height: 90vh;
  transition: all 0.3s ease;
}

h2 {
  font-size: 22px;
  margin-bottom: 18px;
  color: #e0e0ff;
}

.info {
  font-size: 15px;
  color: #aaa;
  margin-bottom: 6px;
}

.balance {
  font-size: 17px;
  color: #00ffae;
  font-weight: 600;
  margin-bottom: 16px;
}

#wallet-address {
  font-weight: 600;
  color: #67b5ff;
  font-size: 15px;
  word-break: break-word;
}

ul#transactions-list {
  list-style: none;
  margin-top: 20px;
  padding: 0;
}

.transaction-item {
  background: #313144;
  border-radius: 16px;
  padding: 18px;
  margin-bottom: 14px;
  box-shadow:
    0 4px 10px rgba(0, 0, 0, 0.3),
    inset 1px 1px 2px rgba(255, 255, 255, 0.02);
  transition: all 0.2s ease;
}

.transaction-item:hover {
  background-color: #38385c;
  transform: translateY(-2px);
}

.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  color: #d1d1e0;
  margin-bottom: 6px;
}

.icon-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  color: #8cbaff;
}

.icon img {
  width: 20px;
  height: 20px;
  filter: brightness(1.2);
}

.amount {
  font-weight: 600;
  color: #00e676;
}

.address {
  font-size: 13px;
  color: #bbb;
  word-break: break-word;
}

.time {
  font-size: 12px;
  color: #888;
  text-align: right;
}

a {
  color: #4fc3f7;
  text-decoration: none;
  font-weight: 500;
}

a:hover {
  text-decoration: underline;
}

.container::-webkit-scrollbar {
  width: 6px;
}

.container::-webkit-scrollbar-thumb {
  background: #444;
  border-radius: 4px;
}

.container::-webkit-scrollbar-thumb:hover {
  background: #666;
}

#disconnect {
  font-size: 16px;
  margin-left: 3px;
  cursor: pointer;
  color: #ff6b6b;
  display: none;
  transition: transform 0.2s ease;
}

#disconnect:hover {
  transform: scale(1.1);
  color: #ff3b3b;
}

/* Responsive điện thoại */
@media (max-width: 600px) {
  .container {
    padding: 20px;
    max-width: 90%;
  }

  h2 {
    font-size: 20px;
  }

  .info,
  .balance,
  #wallet-address,
  .row,
  .address,
  .time {
    font-size: 14px;
  }

  .transaction-item {
    padding: 14px;
  }

  .icon img {
    width: 18px;
    height: 18px;
  }

  #disconnect {
    font-size: 14px;
  }
}

  </style>
</head>
<body>

  <div id="connect-only">
    <div id="connect-wallet"></div>
  </div>

  <div class="container" id="main-content">
    <p class="info">
      <span id="wallet-address">Loading...</span>
      <span id="disconnect" title="Ngắt kết nối">Disconnect</span>
    </p>
    <p id="wallet-balance" class="balance">Loading...</p>
    <ul id="transactions-list"></ul>
  </div>












  <footer>
    <a href="/index/wallet_new.html" class="footer-item" data-page="wallet_new.html">
      <i class="fas fa-wallet"></i>
      <span>Wallet</span>
    </a>
    <a href="/swap/index.html" class="footer-item" data-page="index.html">
      <i class="fas fa-right-left"></i>
      <span>Swap</span>
    </a>
  
    <!-- HOME NỔI BẬT KHÔNG ACTIVE -->
    <a href="/index/index.html" class="footer-item home">
      <div class="home-circle">
        <i class="fas fa-house"></i>
      </div>
      <span>Home</span>
    </a>
  
    <a href="/index/main.html" class="footer-item" data-page="main.html">
      <i class="fas fa-th"></i>
      <span>App</span>
    </a>
    <a href="/index/shop.html" class="footer-item" data-page="shop.html">
      <i class="fas fa-store"></i>
      <span>Shop</span>
    </a>
  </footer>


  <script>
    // Tự động active tab đang mở
const currentPage = location.pathname.split("/").pop();
const items = document.querySelectorAll(".footer-item");

items.forEach(item => {
const page = item.getAttribute("data-page");
if (page === currentPage) {
item.classList.add("active");
}
});
</script>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const connector = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://bmasshd.click/tonconnect-manifest.json",
      buttonRootId: "connect-wallet"
    });

    connector.onStatusChange(async (wallet) => {
      if (wallet) {
        const rawAddress = wallet.account.address;

        document.getElementById("connect-only").style.display = "none";
        document.getElementById("main-content").style.display = "block";

        try {
          const res = await fetch(`https://toncenter.com/api/v2/getExtendedAddressInformation?address=${rawAddress}`);
          const data = await res.json();

          if (data.ok && data.result) {
            const accountAddress = data.result.address.account_address;
            const balanceTon = parseFloat(data.result.balance) / 1e9;
            document.getElementById("wallet-balance").textContent = `Số dư: ${truncateDecimal(balanceTon)} TON`;

            const shortAddress = accountAddress.slice(0, 10) + "..." + accountAddress.slice(-10);
            document.getElementById("wallet-address").textContent = shortAddress;

            document.getElementById("disconnect").style.display = 'inline-block';

            fetchTransactionHistory(rawAddress);
          }
        } catch (err) {
          console.error("Lỗi khi tải thông tin:", err);
        }
      } else {
        document.getElementById("wallet-address").textContent = "...";
        document.getElementById("wallet-balance").textContent = "Số dư: ... TON";
        document.getElementById("disconnect").style.display = 'none';
        document.getElementById("main-content").style.display = "none";
        document.getElementById("connect-only").style.display = "flex";
      }
    });

    document.getElementById("disconnect").addEventListener("click", () => {
      connector.disconnect();
    });

    function truncateDecimal(number) {
      return number % 1 !== 0 ? number.toFixed(9).replace(/0+$/, '').replace(/\.$/, '') : number.toFixed(0);
    }

    async function encodeBase64(str) {
      const encoder = new TextEncoder();
      const bytes = encoder.encode(str);
      let binary = '';
      bytes.forEach((b) => binary += String.fromCharCode(b));
      return btoa(binary);
    }

    async function fetchTransactionHistory(walletAddress) {
      try {
        const response = await fetch(`https://tonapi.io/v2/blockchain/accounts/${walletAddress}/transactions`);
        const data = await response.json();
        const list = document.getElementById("transactions-list");
        list.innerHTML = "";

        if (data.transactions && data.transactions.length > 0) {
          for (const tx of data.transactions) {
            const isReceived = tx.in_msg && tx.in_msg.value > 0;
            const isSent = tx.out_msgs && tx.out_msgs.length > 0 && tx.out_msgs[0].value > 0;

            const address = isReceived
              ? tx.in_msg?.source?.address || 'No'
              : (isSent
                ? tx.out_msgs[0]?.destination?.address || 'No'
                : 'No');

            const amountRaw = isReceived ? tx.in_msg.value : (isSent ? tx.out_msgs[0].value : 0);
            const amountTon = amountRaw / 1e9;
            const time = new Date(tx.utime * 1000).toLocaleString();
            const label = isReceived ? 'Received' : (isSent ? 'Sent' : 'Error');
            const sign = isReceived ? '+ ' : (isSent ? '- ' : ' ');

            const iconPath = isReceived ? '/logo-coin/nhan.png' : (isSent ? '/logo-coin/gui.png' : '/logo-coin/loi.png');

            const li = document.createElement("li");
            li.className = "transaction-item";

            const base64Addr = await encodeBase64(address);

            li.innerHTML = `
              <div class="row">
                <div class="icon-label">
                  <span class="icon"><img src="${iconPath}" alt="icon"></span>
                  <span>${label}</span>
                </div>
                <div class="amount">${sign}${truncateDecimal(amountTon)} TON</div>
              </div>
              <div class="row">
                <div class="address" title="${base64Addr}">
                  <a href="https://tonviewer.com/transaction/${tx.hash}" target="_blank">Transaction</a>
                </div>
                <div class="time">${time}</div>
              </div>
            `;

            list.appendChild(li);
          }
        } else {
          list.innerHTML = "<li>Không có giao dịch nào</li>";
        }
      } catch (error) {
        console.error("Lỗi khi lấy lịch sử giao dịch:", error);
      }
    }
  </script>
</body>
</html>
