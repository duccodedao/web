<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>TON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/css/footer.css">
  <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', 'Roboto', sans-serif;
  background: #e0e5ec;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  color: #333;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

#connect-only {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}

.container {
  display: none;
  background: #e0e5ec;
  border-radius: 20px;
  box-shadow: 10px 10px 25px #bec4d0, -10px -10px 25px #ffffff;
  padding: 30px;
  max-width: 100%; /* ƒê·∫£m b·∫£o chi·ªÅu r·ªông container c√≥ th·ªÉ co gi√£n */
  width: 100%; /* ƒê·∫£m b·∫£o chi·ªÅu r·ªông lu√¥n l√† 100% c·ªßa m√†n h√¨nh */
  text-align: center;
  overflow-y: auto;
  max-height: 90vh;
  margin-top: 65px;
  margin-bottom: 90px;
}

h2 {
  font-size: 22px;
  margin-bottom: 18px;
  color: #2e3a59;
}

.info {
  font-size: 15px;
  color: #555;
  margin-bottom: 6px;
}

.balance {
  font-size: 18px;
  color: #009688;
  font-weight: 700;
  margin-bottom: 4px;
}

#wallet-address {
  font-weight: 600;
  color: #0077cc;
  font-size: 14px;
  word-break: break-word;
}

ul#transactions-list {
  list-style: none;
  margin-top: 20px;
  padding: 0;
}

.transaction-item {
  background: #e0e5ec;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 14px;
  box-shadow: inset 2px 2px 6px #c3c8d3, inset -2px -2px 6px #ffffff;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.transaction-item:hover {
  transform: translateY(-2px);
  box-shadow: inset 2px 2px 8px #b5bbc6, inset -2px -2px 8px #ffffff;
}

.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  color: #2f3d59;
  margin-bottom: 6px;
}

.icon-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  color: #004c99;
}

.icon img {
  width: 20px;
  height: 20px;
}

.amount {
  font-weight: 600;
  color: #00796b;
}

.address {
  font-size: 13px;
  color: #444;
  word-break: break-word;
}

.time {
  font-size: 12px;
  color: #888;
  text-align: right;
}

a {
  color: #0056b3;
  text-decoration: none;
  font-weight: 500;
}

a:hover {
  text-decoration: underline;
}

.container::-webkit-scrollbar {
  width: 6px;
}

.container::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}

.container::-webkit-scrollbar-thumb:hover {
  background: #999;
}

#disconnect {
  font-size: 16px;
  margin-left: 3px;
  cursor: pointer;
  color: #d32f2f;
  display: none;
  transition: transform 0.2s ease;
}

#disconnect:hover {
  transform: scale(1.1);
  color: #b71c1c;
}

@media (max-width: 600px) {
  .container {
    padding: 20px;
    max-width: 92%;
  }

  h2 {
    font-size: 20px;
  }

  .info,
  .balance,
  #wallet-address,
  .row,
  .address,
  .time {
    font-size: 14px;
  }

  .transaction-item {
    padding: 14px;
  }

  .icon img {
    width: 18px;
    height: 18px;
  }

  #disconnect {
    font-size: 14px;
  }
}
.memo {
  white-space: nowrap; /* NgƒÉn kh√¥ng cho text xu·ªëng d√≤ng */
  overflow: hidden; /* ·∫®n ph·∫ßn text b·ªã tr√†n ra */
  text-overflow: ellipsis; /* Hi·ªÉn th·ªã '...' khi qu√° d√†i */
  display: inline-block;
  width: 100%; /* ƒê·∫£m b·∫£o chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
  cursor: pointer; /* Th√™m d·∫•u con tr·ªè khi hover v√†o ph·∫ßn ghi ch√∫ */
  text-align: left; /* ƒê·∫£m b·∫£o ghi ch√∫ n·∫±m l·ªÅ tr√°i */
  transition: max-height 2s ease-out; /* Hi·ªáu ·ª©ng n·ªõi r·ªông nh·∫π nh√†ng */
  max-height: 20px; /* ƒê·∫∑t chi·ªÅu cao t·ªëi ƒëa cho ph·∫ßn thu nh·ªè */
}

.memo.expanded {
  white-space: normal; /* Cho ph√©p xu·ªëng d√≤ng khi m·ªü r·ªông */
  overflow: visible; /* Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß text */
  text-overflow: unset; /* X√≥a d·∫•u '...' */
  text-align: left; /* ƒê·∫£m b·∫£o ghi ch√∫ n·∫±m l·ªÅ tr√°i khi m·ªü r·ªông */
  max-height: 200px; /* Chi·ªÅu cao t·ªëi ƒëa khi m·ªü r·ªông (c√≥ th·ªÉ thay ƒë·ªïi t√πy √Ω) */
}





    .form-send {
  margin-top: 10px;
  text-align: left;
}

.form-send input,
.form-send button {
  width: 100%;
  padding: 10px;
  margin: 1px 0;
  border-radius: 25px;
  border: none;
  font-size: 16px;
  box-shadow: inset 2px 2px 5px #c3c8d3, inset -2px -2px 5px #ffffff;
}

.form-send button {
  background: #00796b;
  color: white;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 3px 3px 8px #a1a1a1;
  transition: background 0.2s ease;
}

.form-send button:hover {
  background: #004d40;
}

    #memo-text:disabled {
  background-color: #f0f0f0;
  color: #999;
  cursor: not-allowed;
}



.input-icon {
  position: relative;
  margin: 10px 0;
}

.input-icon .icon {
  position: absolute;
  top: 50%;
  left: 15px;
  transform: translateY(-50%);
  pointer-events: none;
  font-size: 18px;
  color: #555;
}

.input-icon input {
  padding-left: 45px !important; /* ƒê·ªÉ ch·ª´a kho·∫£ng cho icon */
}
.input-logo {
  position: absolute;
  left: 15px;
  top: 50%;
  border-radius: 25px;
  transform: translateY(-50%);
  width: 20px;
  height: 20px;
  pointer-events: none;
}


  </style>
</head>
<body>

  <div id="connect-only">
    <div id="connect-wallet"></div>
  </div>



  <div class="container" id="main-content">
    <p class="info">
      <span id="wallet-address">Loading...</span>
      <span id="disconnect" title="Ng·∫Øt k·∫øt n·ªëi">Disconnect</span>
    </p>
    <p id="wallet-balance" class="balance">Loading...</p>
    <div class="form-send">
      <h2>G·ª≠i TON</h2>
    
      <div class="input-icon">
        <span class="icon">üì¨</span>
        <input type="text" id="to-address" placeholder="Address">
      </div>
    
      <div class="input-icon">
        <img src="/logo-coin/ton.jpg" alt="TON Logo" class="input-logo">

        <input type="number" id="ton-amount" placeholder="Amount" step="0.01" min="0">
      </div>
      
      
    
      <div class="input-icon">
        <span class="icon">üìù</span>
        <input type="text" id="memo-text" placeholder="Memo" disabled>
      </div>
    
      <button id="send-ton-btn">Sent Transaction</button>
    </div>
    
    <ul id="transactions-list"></ul>
  </div>









  <footer>
    <a href="/index/wallet_new.html" class="footer-item" data-page="wallet_new.html">
      <i class="fas fa-wallet"></i>
      <span>Wallet</span>
    </a>
    <a href="/index/jetton.html" class="footer-item" data-page="jetton.html">
      <i class="fas fa-coins"></i> <!-- Bi·ªÉu t∆∞·ª£ng Coins cho Jetton -->
      <span>Jetton</span>
    </a>
    <a href="/index/main.html" class="footer-item" data-page="main.html">
      <i class="fas fa-th"></i>
      <span>App</span>
    </a>
  
    <!-- Th√™m Profile thay v√¨ Home v√† Shop -->
    <a href="/index/profile.html" class="footer-item" data-page="profile.html">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
  
  </footer>








  <script>
    // T·ª± ƒë·ªông active tab ƒëang m·ªü
const currentPage = location.pathname.split("/").pop();
const items = document.querySelectorAll(".footer-item");

items.forEach(item => {
const page = item.getAttribute("data-page");
if (page === currentPage) {
item.classList.add("active");
}
});
</script>

  <script>
       const tg = window.Telegram.WebApp;
    tg.ready();

    const connector = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://bmasshd.click/tonconnect-manifest.json",
      buttonRootId: "connect-wallet"
    });

    connector.onStatusChange(async (wallet) => {
      if (wallet) {
        const rawAddress = wallet.account.address;

        document.getElementById("connect-only").style.display = "none";
        document.getElementById("main-content").style.display = "block";

        try {
          const res = await fetch(`https://toncenter.com/api/v2/getExtendedAddressInformation?address=${rawAddress}`);
          const data = await res.json();

          if (data.ok && data.result) {
            const accountAddress = data.result.address.account_address;
            const balanceTon = parseFloat(data.result.balance) / 1e9;
            document.getElementById("wallet-balance").textContent = `S·ªë d∆∞: ${truncateDecimal(balanceTon)} TON`;
            document.getElementById("ton-amount").setAttribute("max", balanceTon);


            const shortAddress = accountAddress.slice(0, 10) + "..." + accountAddress.slice(-10);
            document.getElementById("wallet-address").textContent = shortAddress;

            document.getElementById("disconnect").style.display = 'inline-block';

            fetchTransactionHistory(rawAddress);
          }
        } catch (err) {
          console.error("L·ªói khi t·∫£i th√¥ng tin:", err);
        }
      } else {
        document.getElementById("wallet-address").textContent = "...";
        document.getElementById("wallet-balance").textContent = "S·ªë d∆∞: ... TON";
        document.getElementById("disconnect").style.display = 'none';
        document.getElementById("main-content").style.display = "none";
        document.getElementById("connect-only").style.display = "flex";
      }
    });

    document.getElementById("disconnect").addEventListener("click", () => {
      connector.disconnect();
    });

    function truncateDecimal(number) {
      return number % 1 !== 0 ? number.toFixed(9).replace(/0+$/, '').replace(/\.$/, '') : number.toFixed(0);
    }

    async function encodeBase64(str) {
      const encoder = new TextEncoder();
      const bytes = encoder.encode(str);
      let binary = '';
      bytes.forEach((b) => binary += String.fromCharCode(b));
      return btoa(binary);
    }

    async function fetchTransactionHistory(walletAddress) {
  try {
    const response = await fetch(`https://tonapi.io/v2/blockchain/accounts/${walletAddress}/transactions`);
    const data = await response.json();
    const list = document.getElementById("transactions-list");
    list.innerHTML = "";

    if (data.transactions && data.transactions.length > 0) {
      for (const tx of data.transactions) {
        const isReceived = tx.in_msg && tx.in_msg.value > 0;
        const isSent = tx.out_msgs && tx.out_msgs.length > 0 && tx.out_msgs[0].value > 0;

        const address = isReceived
          ? tx.in_msg?.source?.address || 'No'
          : (isSent
            ? tx.out_msgs[0]?.destination?.address || 'No'
            : 'No');

        const amountRaw = isReceived ? tx.in_msg.value : (isSent ? tx.out_msgs[0].value : 0);
        const amountTon = amountRaw / 1e9;
        const time = new Date(tx.utime * 1000).toLocaleString();
        const label = isReceived ? 'Received' : (isSent ? 'Sent' : 'Error');
        const sign = isReceived ? '+ ' : (isSent ? '- ' : ' ');
        const iconPath = isReceived ? '/logo-coin/nhan.png' : (isSent ? '/logo-coin/gui.png' : '/logo-coin/loi.png');

        // üëâ L·∫•y memo/comment n·∫øu c√≥
        const memo = isReceived
          ? tx.in_msg?.message || (tx.in_msg?.decoded_body?.text || 'üìù No memo')
          : (isSent ? tx.out_msgs[0]?.message || (tx.out_msgs[0]?.decoded_body?.text || 'üìù No memo') : 'üìù No memo');

        const li = document.createElement("li");
        li.className = "transaction-item";

        const base64Addr = await encodeBase64(address);

        li.innerHTML = `
          <div class="row">
            <div class="icon-label">
              <span class="icon"><img src="${iconPath}" alt="icon"></span>
              <span>${label}</span>
            </div>
            <div class="amount">${sign}${truncateDecimal(amountTon)} TON</div>
          </div>
          <div class="row">
            <div class="address" title="${base64Addr}">
              <a href="https://tonviewer.com/transaction/${tx.hash}" target="_blank">Transaction</a>
            </div>
            <div class="time">${time}</div>
          </div>
          ${memo ? `<div class="row"><div class="memo" onclick="toggleMemo(this)">${memo}</div></div>` : ''}
        `;

        list.appendChild(li);
      }
    } else {
      list.innerHTML = "<li>Kh√¥ng c√≥ giao d·ªãch n√†o</li>";
    }
  } catch (error) {
    console.error("L·ªói khi l·∫•y l·ªãch s·ª≠ giao d·ªãch:", error);
  }
}

// H√†m m·ªü r·ªông ho·∫∑c thu g·ªçn memo
function toggleMemo(element) {
  element.classList.toggle("expanded");
}
  </script>




<script>
  document.getElementById("send-ton-btn").addEventListener("click", async () => {
    const toAddress = document.getElementById("to-address").value.trim();
    const amountTON = parseFloat(document.getElementById("ton-amount").value);
    const memo = document.getElementById("memo-text").value.trim();
  
    const maxAmount = parseFloat(document.getElementById("ton-amount").getAttribute("max"));
  
    if (!toAddress || isNaN(amountTON) || amountTON <= 0) {
      Swal.fire({
        icon: 'warning',
        title: 'Invalid Input',
        html: '<strong>Please enter a valid address and amount.</strong>',
      });
      return;
    }
  
    if (amountTON > maxAmount) {
      Swal.fire({
        icon: 'error',
        title: 'Amount Exceeded',
        html: `You can only send up to <strong>${truncateDecimal(maxAmount)}</strong> TON.`,
      });
      return;
    }
  
    try {
      const amountNanoTON = BigInt(amountTON * 1e9);
  
      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 60,
        messages: [{
          address: toAddress,
          amount: amountNanoTON.toString(),
          payload: memo ? TON_CONNECT_UI.textToPayload(memo) : undefined
        }]
      };
  
      const result = await connector.sendTransaction(tx);

      Swal.fire({
        icon: 'success',
        title: 'Transaction Sent',
        html: `You have successfully sent <strong>${truncateDecimal(amountTON)}</strong> TON<br>to address <strong>${toAddress}</strong>.`,
      });

      console.log("Result:", result);
    } catch (err) {
      console.error("Error while sending TON:", err);
      Swal.fire({
        icon: 'error',
        title: 'Transaction Failed',
        html: `<strong>Unknown error</strong>`,
      });
    }
  });
</script>


  
</body>
</html>
