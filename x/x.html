<!DOCTYPE html>
<html>
<head>
    <title>Lịch Sử Giao Dịch TON</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        #transaction-history {
            margin-top: 20px;
        }

        #transactions-list {
            list-style: none;
            padding: 0;
        }

        #transactions-list li {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
    </style>
</head>
<body>
    <button id="ton-connect">Kết nối ví</button>
    <div id="wallet-info" style="display: none;">
        <p>Địa chỉ ví: <span id="wallet-address"></span></p>
        <p>Số dư TON: <span id="wallet-balance"></span></p>
        <p>Giá trị USDT: <span id="wallet-usdt-value"></span></p>
        <p>Số dư BMC: <span id="token-balance"></span></p>
    </div>
    <div id="transaction-history" style="display: none;">
        <h2>Lịch Sử Giao Dịch</h2>
        <ul id="transactions-list"></ul>
    </div>

    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://bmasshd.click/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        async function fetchWalletData(wallet) {
            if (!wallet) return;

            const walletAddress = wallet.account.address.toString();
            document.getElementById('wallet-address').textContent = walletAddress;
            document.getElementById('wallet-info').style.display = "block";

            try {
                const tonResponse = await axios.get(`https://tonapi.io/v2/accounts/${walletAddress}`);
                const tonData = tonResponse.data;
                const tonBalance = (tonData.balance / 1e9).toFixed(9);
                document.getElementById('wallet-balance').textContent = `${tonBalance} TON`;

                const priceResponse = await axios.get('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd');
                const priceData = priceResponse.data;
                const tonPrice = priceData['the-open-network'].usd;
                const usdtValue = (tonBalance * tonPrice).toFixed(2);
                document.getElementById('wallet-usdt-value').textContent = `≈ ${usdtValue} USDT`;

                const tokenResponse = await axios.get(`https://tonapi.io/v2/accounts/${walletAddress}/tokens`);
                const tokenData = tokenResponse.data;
                const tokenBMC = tokenData.balances.find(token => token.jetton_address === 'EQCYaB9KjnYpY9j12gn8XIz6SjuYqiTs_1Sg7dbMEiAgr85Y');
                document.getElementById('token-balance').textContent = tokenBMC ? `${(tokenBMC.balance / 1e9).toFixed(2)} BMC` : "0 BMC";

                fetchTransactionHistory(walletAddress);
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Lỗi tải dữ liệu. Vui lòng thử lại sau.");
            }
        }

        async function fetchTransactionHistory(walletAddress) {
            try {
                const response = await axios.get(`https://tonapi.io/v2/blockchain/accounts/${walletAddress}/transactions`);
                const transactionsList = document.getElementById('transactions-list');
                transactionsList.innerHTML = "";

                response.data.transactions.forEach(tx => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                         <strong>Address:</strong> ${
                            tx.out_msgs.length > 0 && tx.out_msgs[0].destination 
                            ? `<a href="https://tonviewer.com/${tx.out_msgs[0].destination.address}" target="_blank" style="text-decoration: none; color: #ff6600;">
                                ${tx.out_msgs[0].destination.address.slice(0, 8)}...${tx.out_msgs[0].destination.address.slice(-8)}
                               </a>` 
                            : 'Error'
                        } <br>
                         <strong>Transaction:</strong> <a href="https://tonviewer.com/transaction/${tx.hash}" target="_blank" style="text-decoration: none; color: #0084ff;">
                            ${tx.hash.slice(0, 10)}...</a> <br>
                         <strong>Type:</strong> <span style="color: ${tx.in_msg ? 'green' : 'red'}; font-weight: bold;">
                            ${tx.in_msg ? 'Received' : (tx.out_msgs.length > 0 ? 'Sent' : 'Unknown')}
                        </span> <br>
                         <strong>Value:</strong> ${(tx.in_msg?.value ? tx.in_msg.value : tx.out_msgs.reduce((sum, msg) => sum + (msg.value || 0), 0)) / 1e9} TON <br>
                         <strong>Created at:</strong> ${new Date(tx.utime * 1000).toLocaleString()} <br>   
                    `;
                    transactionsList.appendChild(listItem);
                });
                document.getElementById('transaction-history').style.display = "block";
            } catch (error) {
                console.error("Error fetching transaction history:", error);
                alert("Lỗi tải lịch sử giao dịch. Vui lòng thử lại sau.");
            }
        }

        document.getElementById('ton-connect').addEventListener('click', async () => {
            try {
                const wallet = await tonConnectUI.connectWallet();
                fetchWalletData(wallet);
            } catch (error) {
                console.error("Error connecting wallet:", error);
                alert("Lỗi kết nối ví. Vui lòng thử lại sau.");
            }
        });
    </script>
</body>
</html>
